@model Web.Models.Volunteer.AddHoursViewModel

@{
    ViewData["Title"] = Model.IsEditing ? "Editar Registro de Horas" : "Registrar Horas de Voluntariado";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";

    var requestInfo = ViewBag.RequestInfo;
    decimal remainingHours = 999;
    decimal totalHours = 0;
    decimal approvedHours = 0;

    try
    {
        if (requestInfo != null)
        {
            remainingHours = (decimal)(requestInfo.RemainingHours ?? 999);
            totalHours = (decimal)(requestInfo.TotalHours ?? 0);
            approvedHours = (decimal)(requestInfo.ApprovedHours ?? 0);
        }
    }
    catch
    {
        // Si hay error, usar valores por defecto
    }
}

@section Styles {
    <style>
        body {
            background-color: #e3e6eb;
        }

        .form-card {
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            background-color: #ffffff;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .time-input {
            font-size: 1.1rem;
            padding: 0.75rem;
        }

        .validation-summary-errors {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

            .validation-summary-errors ul {
                margin: 0;
                padding-left: 1.5rem;
            }

        .page-title {
            color: #007bff;
            font-weight: 600;
            margin-bottom: 1.5rem;
        }

        .form-floating-custom {
            position: relative;
        }

        .floating-counter {
            position: absolute;
            bottom: 8px;
            right: 12px;
            font-size: 0.8rem;
            color: #6c757d;
            background: rgba(255, 255, 255, 0.9);
            padding: 2px 6px;
            border-radius: 4px;
        }
    </style>
}

<div class="container">
    <!-- Header Simple -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="page-title">
            <i class="fas fa-clock me-2"></i>
            @(Model.IsEditing ? "Editar Registro de Horas" : "Registrar Horas de Voluntariado")
        </h1>
        <a asp-action="ManageHours" asp-route-requestId="@Model.RequestId" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i> Volver a Gestión
        </a>
    </div>

    <!-- Información de Ayuda -->
    <div class="form-card">
        <h6><i class="fas fa-info-circle me-2 text-primary"></i>Reglas importantes para el registro de horas</h6>
        <div class="row">
            <div class="col-lg-6">
                <h6 class="text-success mb-3"><i class="fas fa-check-circle me-2"></i>Lo que SÍ puedes hacer:</h6>
                <ul class="list-unstyled">
                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Registrar entre 1 y 8 horas por día</li>
                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Trabajar en cualquier horario (24 horas)</li>
                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Editar horas pendientes o rechazadas</li>
                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Re-registrar después de un rechazo</li>
                </ul>
            </div>
            <div class="col-lg-6">
                <h6 class="text-warning mb-3"><i class="fas fa-exclamation-triangle me-2"></i>Restricciones importantes:</h6>
                <ul class="list-unstyled">
                    <li class="mb-2"><i class="fas fa-times text-danger me-2"></i>No registrar fechas futuras</li>
                    <li class="mb-2"><i class="fas fa-times text-danger me-2"></i>No más de 30 días hacia atrás</li>
                    <li class="mb-2"><i class="fas fa-times text-danger me-2"></i>Solo un registro por día</li>
                    <li class="mb-2"><i class="fas fa-times text-danger me-2"></i>No editar horas ya aprobadas</li>
                    <li class="mb-2"><i class="fas fa-times text-danger me-2"></i>No exceder horas restantes disponibles</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Validation Summary -->
    @if (!ViewData.ModelState.IsValid)
    {
        <div class="validation-summary-errors">
            <h6><i class="fas fa-exclamation-triangle me-2"></i>Por favor corrija los siguientes errores:</h6>
            <ul>
                @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                {
                    <li>@error.ErrorMessage</li>
                }
            </ul>
        </div>
    }

    <!-- Formulario Principal -->
    <div class="form-card">
        @using (Html.BeginForm(Model.IsEditing ? "EditHours" : "AddHours", "VolunteerRequest", FormMethod.Post, new { @class = "needs-validation", novalidate = "novalidate" }))
        {
            @Html.AntiForgeryToken()
            @Html.HiddenFor(m => m.RequestId)
            @if (Model.IsEditing)
            {
                @Html.HiddenFor(m => m.Id)
            }

            <!-- Fecha de Trabajo -->
            <div class="mb-4">
                <label asp-for="Date" class="form-label fw-semibold">
                    <i class="fas fa-calendar me-2 text-primary"></i>Fecha de trabajo
                </label>
                @Html.EditorFor(m => m.Date, new { htmlAttributes = new { @class = "form-control form-control-lg", @required = "required" } })
                @Html.ValidationMessageFor(m => m.Date, "", new { @class = "text-danger small d-block mt-2" })
                <div class="form-text">
                    <i class="fas fa-info-circle me-1"></i>
                    Solo se permite un registro de horas laboradas por día.
                </div>
            </div>

            <div class="row">
                <!-- Hora de Inicio -->
                <div class="col-md-6 mb-4">
                    <label asp-for="StartTime" class="form-label fw-semibold">
                        <i class="fas fa-play me-2 text-success"></i>Hora de inicio
                    </label>
                    @Html.EditorFor(m => m.StartTime, new { htmlAttributes = new { @class = "form-control form-control-lg time-input", @type = "time", @required = "required" } })
                    @Html.ValidationMessageFor(m => m.StartTime, "", new { @class = "text-danger small d-block mt-2" })
                    <div class="form-text">
                        <i class="fas fa-clock me-1"></i>
                        Sin restricción de horario - 24 horas disponibles
                    </div>
                </div>

                <!-- Hora de Fin -->
                <div class="col-md-6 mb-4">
                    <label asp-for="EndTime" class="form-label fw-semibold">
                        <i class="fas fa-stop me-2 text-danger"></i>Hora de fin
                    </label>
                    @Html.EditorFor(m => m.EndTime, new { htmlAttributes = new { @class = "form-control form-control-lg time-input", @type = "time", @required = "required" } })
                    @Html.ValidationMessageFor(m => m.EndTime, "", new { @class = "text-danger small d-block mt-2" })
                    <div class="form-text">
                        <i class="fas fa-hourglass-half me-1"></i>
                        Máximo 8 horas por día, mínimo 1 hora
                    </div>
                </div>
            </div>

            <!-- Descripción de Actividades -->
            <div class="mb-4">
                <label asp-for="ActivitiesDescription" class="form-label fw-semibold">
                    <i class="fas fa-tasks me-2 text-primary"></i>Actividades realizadas
                    <span class="text-danger">*</span>
                </label>
                <div class="form-floating-custom">
                    @Html.TextAreaFor(m => m.ActivitiesDescription, new { @class = "form-control", @rows = "6", @placeholder = "Describe detalladamente las actividades que realizaste durante tu jornada de voluntariado...\n\nEjemplos:\n- Organización de documentos administrativos\n- Atención a beneficiarios\n- Limpieza y mantenimiento de instalaciones\n- Apoyo en actividades educativas\n- Preparación de materiales", @required = "required", @maxlength = "1000" })
                    <div class="floating-counter">
                        <span id="activitiesCounter">0</span>/1000
                    </div>
                </div>
                @Html.ValidationMessageFor(m => m.ActivitiesDescription, "", new { @class = "text-danger small" })
                <div class="form-text">
                    <i class="fas fa-lightbulb me-1"></i>
                    Describe qué hiciste, cómo ayudaste, qué lograste y el impacto de tu trabajo
                </div>
            </div>

            <!-- Notas Adicionales -->
            <div class="mb-4">
                <label asp-for="Notes" class="form-label fw-semibold">
                    <i class="fas fa-sticky-note me-2 text-warning"></i>Notas adicionales
                    <small class="text-muted">(opcional)</small>
                </label>
                <div class="form-floating-custom">
                    @Html.TextAreaFor(m => m.Notes, new { @class = "form-control", @rows = "4", @placeholder = "Observaciones, comentarios, reflexiones sobre tu experiencia, dificultades encontradas, sugerencias de mejora...", @maxlength = "500" })
                    <div class="floating-counter">
                        <span id="notesCounter">0</span>/500
                    </div>
                </div>
                @Html.ValidationMessageFor(m => m.Notes, "", new { @class = "text-danger small" })
                <div class="form-text">
                    <i class="fas fa-comment me-1"></i>
                    Información adicional que consideres relevante para el seguimiento
                </div>
            </div>

            <!-- Botones de Acción -->
            <div class="d-flex gap-3 justify-content-end align-items-center flex-wrap">
                <a asp-action="ManageHours" asp-route-requestId="@Model.RequestId" class="btn btn-secondary btn-lg">
                    <i class="fas fa-times me-2"></i>Cancelar
                </a>
                <button type="submit" class="btn btn-success btn-lg" id="submitBtn">
                    <i class="fas fa-save me-2"></i>
                    @(Model.IsEditing ? "Actualizar Registro" : "Registrar Horas")
                </button>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const activitiesTextarea = document.getElementById('ActivitiesDescription');
            const notesTextarea = document.getElementById('Notes');

            function updateCharCounter(textarea, counterId) {
                const counter = document.getElementById(counterId);
                if (counter && textarea) {
                    counter.textContent = textarea.value.length;
                }
            }

            if (activitiesTextarea) {
                activitiesTextarea.addEventListener('input', function() {
                    updateCharCounter(this, 'activitiesCounter');
                });
                updateCharCounter(activitiesTextarea, 'activitiesCounter');
            }

            if (notesTextarea) {
                notesTextarea.addEventListener('input', function() {
                    updateCharCounter(this, 'notesCounter');
                });
                updateCharCounter(notesTextarea, 'notesCounter');
            }
        });
    </script>
}