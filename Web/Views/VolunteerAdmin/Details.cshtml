@model Shared.Dtos.Volunteer.VolunteerRequestDto

@{
    ViewData["Title"] = $"Detalles de Solicitud #{Model.Id}";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
}

<style>
        body {
            background-color: #e3e6eb;
        }

        .details-card {
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            background-color: #ffffff;
            padding: 2rem;
            margin-bottom: 1.5rem;
        }

        .info-row {
            border-bottom: 1px solid #f8f9fa;
            padding: 0.75rem 0;
        }

            .info-row:last-child {
                border-bottom: none;
            }

        .rejection-reason {
            background-color: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 1rem;
            color: #dc2626;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .description-box {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: pre-wrap;
        }

        .progress-box {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 0.5rem;
        }

        {
            padding: 1rem;
        }

        .container {
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }
</style>

<div class="container">
    <!-- Header -->
    <div class="mb-4">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
            <h1 class="h3 fw-bold text-primary">
                <i class="fas fa-file-alt me-2"></i>Detalles de Solicitud
            </h1>
            <div>
                <a asp-action="Index" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Volver a Lista
                </a>
            </div>
        </div>
    </div>

    <!-- Información de la Solicitud -->
    <div class="details-card">
        <h5 class="mb-4">
            <i class="fas fa-info-circle me-2 text-primary"></i>Información de la Solicitud
        </h5>

        <div class="info-row">
            <strong>Estado actual:</strong>
            <div class="mt-1">
                @if (Model.State == Shared.Enums.VolunteerState.Pending)
                {
                    <span class="text-warning fw-bold">
                        <i class="fas fa-hourglass-half me-1"></i>Pendiente
                    </span>
                    <small class="text-muted d-block mt-1">Esperando aprobación</small>
                }
                else if (Model.State == Shared.Enums.VolunteerState.Approved)
                {
                    <span class="text-success fw-bold">
                        <i class="fas fa-check-circle me-1"></i>Aprobada
                    </span>
                    <small class="text-muted d-block mt-1">El voluntario puede registrar horas</small>
                }
                else if (Model.State == Shared.Enums.VolunteerState.Rejected)
                {
                    <span class="text-danger fw-bold">
                        <i class="fas fa-times-circle me-1"></i>Rechazada
                    </span>
                    <small class="text-muted d-block mt-1">Ver motivo abajo</small>
                }
            </div>
        </div>

        <div class="info-row">
            <strong>Fecha de solicitud:</strong>
            <div class="mt-1">@Model.CreatedAt.ToString("dd/MM/yyyy HH:mm")</div>
        </div>

        <div class="info-row">
            <strong>Voluntario:</strong>
            <div class="mt-1">@(Model.VolunteerName ?? "N/A")</div>
        </div>

        <div class="info-row">
            <strong>Institución:</strong>
            <div class="mt-1">@Model.Institution</div>
        </div>

        <div class="info-row">
            <strong>Profesión:</strong>
            <div class="mt-1">@Model.Profession</div>
        </div>

        <div class="info-row">
            <strong>Horas solicitadas:</strong>
            <div class="mt-1">@Model.Hours horas</div>
        </div>

        <div class="info-row">
            <strong>Descripción del trabajo:</strong>
            <div class="mt-2 description-box">
                @Model.Description
            </div>
        </div>

        @if (Model.ApprovedAt.HasValue)
        {
            <div class="info-row">
                <strong>Fecha de procesamiento:</strong>
                <div class="mt-1">@Model.ApprovedAt.Value.ToString("dd/MM/yyyy HH:mm")</div>
            </div>
        }

        @if (Model.ApproverId.HasValue && !string.IsNullOrEmpty(Model.ApproverName))
        {
            <div class="info-row">
                <strong>Procesado por:</strong>
                <div class="mt-1">@Model.ApproverName</div>
            </div>
        }

        <!-- Razón de Rechazo dentro del mismo card -->
        @if (Model.State == Shared.Enums.VolunteerState.Rejected && !string.IsNullOrEmpty(Model.RejectionReason))
        {
            <div class="info-row">
                <strong class="text-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>Razón del Rechazo:
                </strong>
                <div class="mt-2 rejection-reason">
                    @Model.RejectionReason
                </div>
            </div>
        }
    </div>
</div>

<!-- Modal para Rechazo -->
<div class="modal fade" id="rejectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-times-circle text-danger"></i> Rechazar Solicitud
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>¿Está seguro que desea rechazar la solicitud de <strong id="volunteerName"></strong>?</p>
                <div class="mb-3">
                    <label for="rejectionReason" class="form-label">Razón del rechazo <span class="text-danger">*</span></label>
                    <textarea id="rejectionReason" class="form-control" rows="3"
                              placeholder="Explique por qué se rechaza la solicitud..."
                              required minlength="10" maxlength="500"></textarea>
                    <div class="form-text">Mínimo 10 caracteres.</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmRejectBtn">
                    <i class="fas fa-times me-1"></i> Rechazar
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @Html.AntiForgeryToken()
    <script>
        let currentRequestId = 0;

        function quickApprove(requestId) {
            if (!confirm('¿Aprobar esta solicitud?')) return;

            fetch('@Url.Action("QuickApprove")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                },
                body: `id=${requestId}`
            })
            .then(async response => {
                const data = await response.json();
                if (response.ok && data.success) {
                    alert('Solicitud aprobada exitosamente');
                    location.reload();
                } else {
                    alert('Error: ' + (data?.message ?? 'No se pudo aprobar'));
                }
            })
            .catch(error => {
                alert('Error al procesar la aprobación');
            });
        }

        function showRejectModal(requestId, volunteerName) {
            currentRequestId = requestId;
            document.getElementById('volunteerName').textContent = volunteerName || 'N/A';
            document.getElementById('rejectionReason').value = '';
            new bootstrap.Modal(document.getElementById('rejectModal')).show();
        }

        document.getElementById('confirmRejectBtn')?.addEventListener('click', function () {
            const reason = document.getElementById('rejectionReason').value.trim();

            if (!reason || reason.length < 10) {
                alert('Debe proporcionar una razón de al menos 10 caracteres');
                return;
            }

            fetch('@Url.Action("QuickReject")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                },
                body: `id=${currentRequestId}&reason=${encodeURIComponent(reason)}`
            })
            .then(async response => {
                const data = await response.json();
                if (response.ok && data.success) {
                    alert('Solicitud rechazada exitosamente');
                    bootstrap.Modal.getInstance(document.getElementById('rejectModal')).hide();
                    location.reload();
                } else {
                    alert('Error: ' + (data?.message ?? 'No se pudo rechazar'));
                }
            })
            .catch(error => {
                alert('Error al procesar el rechazo');
            });
        });
    </script>
}